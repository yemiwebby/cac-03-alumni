name: Birthday Reminders

on:
  schedule:
    # Daily reminders at 9:00 AM UTC (10:00 AM BST/11:00 AM CEST)
    - cron: "0 9 * * *"
    # Monthly report on 1st of every month at 8:00 AM UTC
    - cron: "0 8 1 * *"

  # Allow manual triggering for testing (RESTRICTED: Owner and collaborators only)
  workflow_dispatch:
    inputs:
      mode:
        description: "Run mode"
        required: true
        default: "daily"
        type: choice
        options:
          - daily
          - monthly
      dry_run:
        description: "Dry run (test mode)"
        required: true
        default: true
        type: boolean
      target_month:
        description: "Target month for monthly reports (1-12, 0=auto)"
        required: false
        default: "0"
        type: choice
        options:
          - "0" # Auto (next month)
          - "1" # January
          - "2" # February
          - "3" # March
          - "4" # April
          - "5" # May
          - "6" # June
          - "7" # July
          - "8" # August
          - "9" # September
          - "10" # October
          - "11" # November
          - "12" # December

# Security: Restrict workflow permissions
permissions:
  contents: read
  actions: read

jobs:
  daily-reminders:
    if: github.event.schedule == '0 9 * * *' || (github.event.inputs.mode == 'daily' && github.event_name == 'workflow_dispatch')
    runs-on: ubuntu-latest
    steps:
      # Security: Verify authorized user for manual triggers
      - name: Check authorization
        if: github.event_name == 'workflow_dispatch'
        run: |
          if [[ "${{ github.actor }}" != "${{ github.repository_owner }}" ]]; then
            echo "âŒ Unauthorized: Only the repository owner can manually trigger this workflow"
            echo "Current user: ${{ github.actor }}"
            echo "Repository owner: ${{ github.repository_owner }}"
            exit 1
          fi
          echo "âœ… Authorized user: ${{ github.actor }}"

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.24"

      - name: Download dependencies
        run: go mod download

      # Security: Create CSV file from encrypted secret
      - name: Create CSV file from secret
        env:
          CSV_CONTENT: ${{ secrets.CSV_DATA }}
        run: |
          echo "ðŸ” Creating CSV file from encrypted secret..."
          mkdir -p file
          printf '%s\n' "$CSV_CONTENT" > file/CAC-03-SET-BIODATA-FORM.csv
          echo "âœ… CSV file created securely"
          echo "ðŸ“Š CSV contains $(wc -l < file/CAC-03-SET-BIODATA-FORM.csv) lines"

      - name: Send daily birthday reminders
        env:
          WA_PHONE_ID: ${{ secrets.WA_PHONE_ID }}
          WA_TOKEN: ${{ secrets.WA_TOKEN }}
          WA_TEMPLATE: ${{ secrets.WA_TEMPLATE }}
          WA_LANG: ${{ secrets.WA_LANG }}
          WA_TO_LIST: ${{ secrets.WA_TO_LIST }}
          TIMEZONE: ${{ secrets.TIMEZONE }}
          CSV_PATH: file/CAC-03-SET-BIODATA-FORM.csv
        run: |
          echo "ðŸ”’ Security: Running as authorized user ${{ github.actor }}"
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "ðŸ§ª Running in DRY RUN mode (no messages will be sent)"
            go run cmd/main.go -dry
          else
            echo "ðŸ“± Running in LIVE mode (messages will be sent)"
            go run cmd/main.go
          fi

  monthly-report:
    if: github.event.schedule == '0 8 1 * *' || (github.event.inputs.mode == 'monthly' && github.event_name == 'workflow_dispatch')
    runs-on: ubuntu-latest
    steps:
      # Security: Verify authorized user for manual triggers
      - name: Check authorization
        if: github.event_name == 'workflow_dispatch'
        run: |
          if [[ "${{ github.actor }}" != "${{ github.repository_owner }}" ]]; then
            echo "âŒ Unauthorized: Only the repository owner can manually trigger this workflow"
            echo "Current user: ${{ github.actor }}"
            echo "Repository owner: ${{ github.repository_owner }}"
            exit 1
          fi
          echo "âœ… Authorized user: ${{ github.actor }}"

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.24"

      - name: Download dependencies
        run: go mod download

      # Security: Create CSV file from encrypted secret
      - name: Create CSV file from secret
        env:
          CSV_CONTENT: ${{ secrets.CSV_DATA }}
        run: |
          echo "ðŸ” Creating CSV file from encrypted secret..."
          mkdir -p file
          printf '%s\n' "$CSV_CONTENT" > file/CAC-03-SET-BIODATA-FORM.csv
          echo "âœ… CSV file created securely"
          echo "ðŸ“Š CSV contains $(wc -l < file/CAC-03-SET-BIODATA-FORM.csv) lines"

      - name: Send monthly birthday report
        env:
          WA_PHONE_ID: ${{ secrets.WA_PHONE_ID }}
          WA_TOKEN: ${{ secrets.WA_TOKEN }}
          WA_TEMPLATE: ${{ secrets.WA_TEMPLATE }}
          WA_LANG: ${{ secrets.WA_LANG }}
          WA_TO_LIST: ${{ secrets.WA_TO_LIST }}
          TIMEZONE: ${{ secrets.TIMEZONE }}
          CSV_PATH: file/CAC-03-SET-BIODATA-FORM.csv
        run: |
          echo "ðŸ”’ Security: Running as authorized user ${{ github.actor }}"
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "ðŸ§ª Running in DRY RUN mode (no messages will be sent)"
            if [ "${{ github.event.inputs.target_month }}" != "0" ]; then
              go run cmd/main.go -monthly -dry -target-month=${{ github.event.inputs.target_month }}
            else
              go run cmd/main.go -monthly -dry
            fi
          else
            echo "ðŸ“± Running in LIVE mode (messages will be sent)"
            if [ "${{ github.event.inputs.target_month }}" != "0" ]; then
              go run cmd/main.go -monthly -target-month=${{ github.event.inputs.target_month }}
            else
              go run cmd/main.go -monthly
            fi
          fi
